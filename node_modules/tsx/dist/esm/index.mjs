var K=Object.defineProperty;var m=(t,e)=>K(t,"name",{value:e,configurable:!0});import{isMainThread as V}from"node:worker_threads";import{i as p,a as Y,e as T,l as w,r as Z,m as x}from"../node-features-Bp94mr_V.mjs";import{r as tt}from"../register-EpxomN4w.mjs";import"../get-pipe-path-BHW2eJdv.mjs";import"node:module";import u from"node:path";import{fileURLToPath as N,pathToFileURL as _}from"node:url";import"get-tsconfig";import{l as J,t as et,f as y,b as h,d as l,e as st,g as d,h as L,j as C,k as W,m as k,n as A,o as at,p as I,q as rt,s as M}from"../register-E1Wrjy-L.mjs";import $ from"node:fs";import"esbuild";import"node:crypto";import{t as D,a as U,i as q,b as B,r as ot}from"../index-7AaEi15b.mjs";import{p as Q}from"../client-BQVF1NaW.mjs";import"../require-B1Lfr0sv.mjs";import{readFile as R}from"node:fs/promises";import"module";import"../temporary-directory-CwHp0_NW.mjs";import"node:os";import"node:util";import"../index-gbaejti9.mjs";import"node:net";const f={active:!0},nt=m(async t=>{if(!t)throw new Error(`tsx must be loaded with --import instead of --loader
The --loader flag was deprecated in Node v20.6.0 and v18.19.0`);f.namespace=t.namespace,t.tsconfig!==!1&&J(t.tsconfig??process.env.TSX_TSCONFIG_PATH),t.port&&(f.port=t.port,t.port.on("message",e=>{e==="deactivate"&&(f.active=!1,t.port.postMessage({type:"deactivated"}))}))},"initialize"),it=m(()=>(J(process.env.TSX_TSCONFIG_PATH),"process.setSourceMapsEnabled(true);"),"globalPreload"),j=new Map,ct=m(async t=>{if(j.has(t))return j.get(t);if(!await $.promises.access(t).then(()=>!0,()=>!1)){j.set(t,void 0);return}const o=await $.promises.readFile(t,"utf8");try{const s=JSON.parse(o);return j.set(t,s),s}catch{throw new Error(`Error parsing: ${t}`)}},"readPackageJson"),mt=m(async t=>{let e=new URL("package.json",t);for(;!e.pathname.endsWith("/node_modules/package.json");){const o=N(e),s=await ct(o);if(s)return s;const r=e;if(e=new URL("../package.json",e),e.pathname===r.pathname)break}},"findPackageJson"),dt=m(async t=>(await mt(t))?.type??"commonjs","getPackageType"),ft=m(t=>{[t]=t.split("?");const e=u.extname(t);if(e===".mts")return"module";if(e===".cts")return"commonjs"},"getFormatFromExtension"),pt=m(t=>{const e=ft(t);if(e)return e;const{pathname:o}=new URL(t),s=u.extname(o);if(s===".js"||et.includes(s))return dt(t)},"getFormatFromFileUrl"),P="tsx-namespace=",E=m(t=>{const e=t.indexOf(P);if(e===-1)return;const o=t[e-1];if(o!=="?"&&o!=="&")return;const s=e+P.length,r=t.indexOf("&",s);return r===-1?t.slice(s):t.slice(s,r)},"getNamespace"),F=m(t=>{if(!t.includes("%3F"))return t;const[e,o]=t.split("%3F",2),s=decodeURIComponent(o);return`${e}?${s}`},"decodeCjsQuery"),G=p(Y)?"importAttributes":"importAssertions";let b=m(async(t,e,o)=>{if(!f.active)return o(t,e);t=F(t);const s=E(t);if(f.namespace&&f.namespace!==s)return o(t,e);if(f.port){const a=new URL(t);a.searchParams.delete("tsx-namespace"),f.port.postMessage({type:"load",url:a.toString()})}Q.send&&Q.send({type:"dependency",path:t});const r=t.startsWith(y)?N(t):t;if(e.format==="module-json"){const a=await R(new URL(t),"utf8"),c=await D(a,r,{tsconfigRaw:u.isAbsolute(r)?h?.(r):void 0});return{shortCircuit:!0,format:"module",source:l(c)}}if(e.format==="commonjs-json"){const a=await R(new URL(t),"utf8"),c=U(a,r,{tsconfigRaw:u.isAbsolute(r)?h?.(r):void 0});return c.code+=`
0 && (module.exports = ${JSON.stringify(Object.fromEntries(Object.keys(JSON.parse(a)).map(g=>[g,0])))});`,{shortCircuit:!0,format:"commonjs",source:l(c)}}if((e.format===void 0||e.format==="commonjs"||e.format==="commonjs-typescript")&&p(T)&&t.startsWith("file:")&&r.endsWith(".js")){const a=await R(new URL(t),"utf8");if(q(a)){const c=U(a,t,{tsconfigRaw:h?.(r)});if(p(w))return{shortCircuit:!0,format:"commonjs",source:l(c)};const g=s?`${r}?namespace=${encodeURIComponent(s)}`:r;return{shortCircuit:!0,format:"commonjs",responseURL:`data:text/javascript,${encodeURIComponent(c.code)}?filePath=${encodeURIComponent(g)}`}}}if(st.test(t)){let a=e[G];a||(a={},e[G]=a),a.type||(a.type="json")}const i=await o(t,e);if(d(3,"loaded by next loader",{url:t,loaded:i}),i.format==="commonjs"){if(p(w)&&r.endsWith(".cjs")){let a=await R(new URL(t),"utf8");const c=B(r,a);return c&&(a=l(c)),i.source=a,i.shortCircuit=!0,i}if(p(T)&&i.responseURL?.startsWith("file:")&&!r.endsWith(".cjs")){const a=await R(new URL(t),"utf8");if(!r.endsWith(".js")||q(a)){const c=U(a,t,{tsconfigRaw:h?.(r)});if(p(w))i.source=l(c);else{const g=s?`${r}?namespace=${encodeURIComponent(s)}`:r;i.responseURL=`data:text/javascript,${encodeURIComponent(c.code)}?filePath=${encodeURIComponent(g)}`}return i}if(!i.source)return i.source=a,i}}if(!i.source)return i;const n=i.source.toString();if(p(Z)&&i.format==="json"){const a=U(n,r,{tsconfigRaw:u.isAbsolute(r)?h?.(r):void 0});return a.code+=`
0 && (module.exports = ${JSON.stringify(Object.fromEntries(Object.keys(JSON.parse(n)).map(c=>[c,0])))});`,{format:"commonjs",source:l(a)}}if(i.format==="json"||L.test(t)){const a=await D(n,r,{tsconfigRaw:u.isAbsolute(r)?h?.(r):void 0});return{format:"module",source:l(a)}}if(i.format==="module"){const a=B(r,n);a&&(i.source=l(a))}return i},"load");if(C){const t=b;b=m(async(e,o,s)=>{d(2,"load",{url:e,context:o});const r=await t(e,o,s);return d(1,"loaded",{url:e,result:r}),r},"load")}const H=m(t=>{if(t.url)return t.url;const e=t.message.match(/^Cannot find module '([^']+)'/);if(e){const[,s]=e;return s}const o=t.message.match(/^Cannot find package '([^']+)'/);if(o){const[,s]=o;if(!u.isAbsolute(s))return;const r=_(s);if(r.pathname.endsWith("/")&&(r.pathname+="package.json"),r.pathname.endsWith("/package.json")){const i=ot(r);if(i?.main)return new URL(i.main,r).toString()}else return r.toString()}},"getMissingPathFromNotFound"),v=m(async(t,e,o,s)=>{const r=at(t);if(d(3,"resolveExtensions",{url:t,context:e,throwError:s,tryPaths:r}),!r)return;let i;for(const n of r)try{return await o(n,e)}catch(a){const{code:c}=a;if(c!=="ERR_MODULE_NOT_FOUND"&&c!=="ERR_PACKAGE_PATH_NOT_EXPORTED")throw a;i=a}if(s)throw i},"resolveExtensions"),ut=m(async(t,e,o)=>{if(d(3,"resolveBase",{specifier:t,context:e,specifierStartsWithFileUrl:t.startsWith(y),isRelativePath:I(t),specifierNodeModules:t.includes(rt),tsExtensionsPattern:L.test(e.parentURL),allowJs:M}),(t.startsWith(y)||I(t))&&!t.includes("/node_modules/")&&(L.test(e.parentURL)||M)){const s=await v(t,e,o);if(d(3,"resolveBase resolved",{specifier:t,context:e,resolved:s}),s)return s}try{return await o(t,e)}catch(s){if(d(3,"resolveBase error",{specifier:t,context:e,error:s}),s instanceof Error){const r=s;if(r.code==="ERR_MODULE_NOT_FOUND"){const i=H(r);if(i){const n=await v(i,e,o);if(n)return n}}}throw s}},"resolveBase"),X=m(async(t,e,o)=>{if(d(3,"resolveDirectory",{specifier:t,context:e,isDirectory:A.test(t)}),(t==="."||t===".."||t.endsWith("/.."))&&(t+="/"),A.test(t)){const s=new URL(t,e.parentURL);return s.pathname=u.join(s.pathname,"index"),await v(s.toString(),e,o,!0)}try{return await ut(t,e,o)}catch(s){if(s instanceof Error){d(3,"resolveDirectory error",{specifier:t,context:e,error:s});const r=s;if(r.code==="ERR_UNSUPPORTED_DIR_IMPORT"){const i=H(r);if(i)try{return await v(`${i}/index`,e,o,!0)}catch(n){const a=n,{message:c}=a;throw a.message=a.message.replace(`${"/index".replace("/",u.sep)}'`,"'"),a.stack=a.stack.replace(c,a.message),a}}}throw s}},"resolveDirectory"),lt=m(async(t,e,o)=>{if(d(3,"resolveTsPaths",{specifier:t,context:e,requestAcceptsQuery:W(t),tsconfigPathsMatcher:k,fromNodeModules:e.parentURL?.includes("/node_modules/")}),!W(t)&&k&&!e.parentURL?.includes("/node_modules/")){const s=k(t);d(3,"resolveTsPaths",{possiblePaths:s});for(const r of s)try{return await X(_(r).toString(),e,o)}catch{}}return X(t,e,o)},"resolveTsPaths"),z="tsx://",S=new Map;let O=m(async(t,e,o)=>{if(!f.active||t.startsWith("node:"))return o(t,e);p(w)&&(t.includes("%3F")&&(t=F(t)),e.parentURL?.includes("%3F")&&(e.parentURL=F(e.parentURL)));let s=E(t)??(e.parentURL&&E(e.parentURL));if(f.namespace){let a;if(t.startsWith(z)){try{a=JSON.parse(t.slice(z.length))}catch{}a?.namespace&&(s=a.namespace)}if(f.namespace!==s)return o(t,e);a&&(t=a.specifier,e.parentURL=a.parentURL)}const[r,i]=t.split("?"),n=await lt(r,e,o);if(d(2,"nextResolve",{resolved:n}),n.format==="builtin")return n;if(!n.format&&n.url.startsWith(y)&&(n.format=await pt(n.url),d(2,"getFormatFromFileUrl",{resolved:n,format:n.format})),i&&(n.url+=`?${i}`),s&&!n.url.includes(P)&&(n.url+=(n.url.includes("?")?"&":"?")+P+s),n.format==="commonjs-typescript"&&(n.format="commonjs"),n.format==="module-typescript"&&(n.format="module"),n.format==="module"&&e.parentURL&&S.get(e.parentURL)==="commonjs"&&(n.format="commonjs"),n.format==="json"&&e.parentURL){const a=S.get(e.parentURL);a==="commonjs"&&(n.format="commonjs-json"),a==="module"&&(n.format="module-json")}if(S.set(n.url,n.format),p([[20,11,0],[22,10,0]])&&n.format==="commonjs"&&n.url.includes("?")){const[a,c]=n.url.split("?");n.url=a+encodeURIComponent(`?${c}`)}return n},"resolve");if(C){const t=O;O=m(async(e,o,s)=>{d(2,"resolve",{specifier:e,context:o});const r=await t(e,o,s);return d(1,"resolved",{specifier:e,context:o,result:r}),r},"resolve")}p(x)&&V&&tt();export{it as globalPreload,nt as initialize,b as load,O as resolve};
