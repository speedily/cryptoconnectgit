import { stringify } from "viem/utils";
import { observe } from "../utils/observe.js";
import { poll } from "../utils/poll.js";
import { getUserIntentExecutionReceipt } from "./getUserIntentExecutionReceipt.js";
export class WaitForUserIntentExecutionReceiptTimeoutError extends Error {
    constructor({ uiHash }) {
        super(`Timed out waiting for user intent execution receipt: ${uiHash}`);
    }
}
/**
 * Waits for a User Intent execution receipt to be ready.
 *
 * - Polls {@link getUserIntentExecutionReceipt} on a specified interval.
 * - If the receipt is found, returns the receipt.
 * - If the receipt times out or exceeds retry count, throws an error.
 *
 * @param client - Client to use
 * @param parameters - {@link WaitForUserIntentExecutionReceiptParameters}
 * @returns The execution receipt of the user intent. {@link WaitForUserIntentExecutionReceiptReturnType}
 *
 * @example
 * import { createIntentClient, http } from '@zerodev/intent'
 * import { mainnet } from 'viem/chains'
 *
 * const client = createIntentClient({
 *   chain: mainnet,
 *   transport: http(),
 * })
 *
 * const receipt = await client.waitForUserIntentExecutionReceipt({
 *   uiHash: '0x...',
 * })
 */
export function waitForUserIntentExecutionReceipt(client, parameters, version) {
    const { uiHash, pollingInterval = Math.min(client.pollingInterval, 1000), retryCount, timeout = 120_000, } = parameters;
    let count = 0;
    const observerId = stringify([
        "waitForUserIntentExecutionReceipt",
        client.uid,
        uiHash,
    ]);
    return new Promise((resolve, reject) => {
        const unobserve = observe(observerId, { resolve, reject }, (emit) => {
            const done = (fn) => {
                unpoll();
                fn();
                unobserve();
            };
            const unpoll = poll(async () => {
                if (retryCount && count >= retryCount)
                    done(() => emit.reject(new WaitForUserIntentExecutionReceiptTimeoutError({ uiHash })));
                try {
                    const receipt = await getUserIntentExecutionReceipt(client, {
                        uiHash,
                    }, version);
                    if (receipt)
                        done(() => emit.resolve(receipt));
                }
                catch (err) {
                    done(() => emit.reject(err));
                }
                count++;
            }, {
                emitOnBegin: true,
                interval: pollingInterval,
            });
            if (timeout)
                setTimeout(() => done(() => emit.reject(new WaitForUserIntentExecutionReceiptTimeoutError({ uiHash }))), timeout);
            return unpoll;
        });
    });
}
//# sourceMappingURL=waitForUserIntentExecutionReceipt.js.map